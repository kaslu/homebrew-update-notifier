#!/bin/bash
#
# Notify of Homebrew updates via Notification Center on Mac OS X
#
# Author: Richard Woeber
# based on the work of Chris Streeter http://www.chrisstreeter.com

eval $(/usr/libexec/path_helper -s)

BREW=$(which brew)
TERMINAL_NOTIFIER=$(which terminal-notifier)

${BREW} update 2>&1 > /dev/null

# Check if terminal-notifier is installed
if [ -e ${TERMINAL_NOTIFIER} ]; then
    outdated=$(${BREW} outdated --quiet)
    pinned=$(${BREW} list --pinned)

    # Remove pinned formulae from the list of outdated formulae
    outdated=$(comm -1 -3 <(echo "${pinned}") <(echo "${outdated}"))

    # Check if not empty
    if [ -n "${outdated}" ]; then
        # join lines together with ", " and remove possible trailing comma character
        outdated=$(perl -pe 's/\n/, /g' <(echo "${outdated}") | sed 's/, $//g')

        title="Outdated Homebrew formulae"
        message=$(printf "The following formulae are outdated:\n${outdated}")

        ${TERMINAL_NOTIFIER} ${NOTIFIER} -title "${title}" -message "${message}"
    fi

    # Check if brew cask is installed
    if ! brew cask &>/dev/null; then
        exit
    fi

fi

exit 0
